<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGen Studio & Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background-color: #000; 
            color: #fff; 
        }
        
        .studio-input {
            background: #0f0f0f;
            border: 1px solid #333;
            color: #fff;
            transition: all 0.2s;
        }
        .studio-input:focus {
            border-color: #00ff88;
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .studio-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .studio-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }

        .admin-card {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        /* Flash animation for updates */
        @keyframes highlightUpdate {
            0% { background-color: rgba(0, 255, 136, 0.2); border-color: #00ff88; }
            100% { background-color: #111; border-color: #333; }
        }
        .flash-update {
            animation: highlightUpdate 1s ease-out;
        }

        .image-card {
            background: #050505;
            border: 1px solid #1a1a1a;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .image-card.enhancing {
            border-color: #ff9900;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.1);
        }
        .image-card.done {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .progress-fill { transition: width 0.3s ease; }
        
        /* Auth Styles */
        .glass-panel {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .hidden-app { display: none !important; }
        
        /* Live Indicator Pulse */
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 255, 136, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        .live-dot {
            animation: pulse-green 1.5s infinite;
        }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">

    <!-- AUTHENTICATION OVERLAY -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md shadow-[0_0_50px_rgba(0,255,136,0.1)] border border-[#00ff88]/20">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold tracking-tighter text-white">PRO<span class="text-[#00ff88]">GEN</span></h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest mt-2">Member Access</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold ml-1">Email</label>
                    <input type="email" id="login-email" class="studio-input w-full rounded-lg p-3 mt-1" placeholder="user@progen.com" required>
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold ml-1">Password</label>
                    <input type="password" id="login-password" class="studio-input w-full rounded-lg p-3 mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="studio-btn w-full py-3 rounded-lg mt-4">Login</button>
                <p class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white" onclick="toggleAuthMode()">
                    New User? <span class="text-[#00ff88] underline">Sign Up Here</span>
                </p>
            </form>

            <!-- Signup Form (Hidden) -->
            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold ml-1">New Email</label>
                    <input type="email" id="signup-email" class="studio-input w-full rounded-lg p-3 mt-1" placeholder="new@progen.com" required>
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold ml-1">Set Password</label>
                    <input type="password" id="signup-password" class="studio-input w-full rounded-lg p-3 mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="studio-btn w-full py-3 rounded-lg mt-4 bg-gradient-to-r from-blue-500 to-cyan-500 border-none text-white">Create Account</button>
                <p class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white" onclick="toggleAuthMode()">
                    Already have access? <span class="text-[#00ff88] underline">Login Here</span>
                </p>
            </form>
            
            <div id="auth-error" class="text-red-500 text-xs text-center mt-4 hidden font-mono"></div>
        </div>
    </div>

    <!-- MAIN APP (Protected) -->
    <div id="main-app" class="hidden-app min-h-screen p-4 md:p-8 opacity-0 transition-opacity duration-1000">
        
        <!-- Live Announcement Banner (Hidden by default) -->
        <div id="announcement-banner" class="hidden mb-6 bg-gradient-to-r from-[#00ff88]/20 to-blue-600/20 border border-[#00ff88]/30 p-4 rounded-xl flex items-center justify-center gap-3 animate-pulse shadow-[0_0_30px_rgba(0,255,136,0.1)]">
            <span class="text-xl">üì¢</span>
            <span id="announcement-text" class="text-sm md:text-base font-bold text-white tracking-wide font-mono"></span>
        </div>

        <!-- Navbar -->
        <nav class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold tracking-tighter text-white">PRO<span class="text-[#00ff88]">GEN</span></h1>
                <span class="px-2 py-0.5 bg-[#00ff88]/10 text-[#00ff88] border border-[#00ff88]/30 rounded text-[10px] font-bold tracking-widest uppercase">Studio</span>
            </div>
            <div class="flex items-center gap-4">
                <!-- Admin Stats Button (Hidden by default) -->
                <button id="admin-stats-btn" onclick="toggleAdminPanel()" class="hidden text-xs text-[#00ff88] hover:text-white uppercase font-bold tracking-widest border border-[#00ff88]/50 px-4 py-2 rounded hover:bg-[#00ff88]/20 transition flex items-center gap-2">
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    Live Stats
                </button>
                
                <span id="user-email-display" class="text-xs text-gray-500 font-mono hidden md:block"></span>
                <button onclick="handleLogout()" class="text-xs text-red-400 hover:text-white uppercase font-bold tracking-widest border border-red-900/50 px-4 py-2 rounded hover:bg-red-900/50 transition">
                    Logout
                </button>
            </div>
        </nav>

        <!-- ADMIN DASHBOARD (Overlay) -->
        <div id="admin-dashboard" class="hidden fixed inset-0 z-40 bg-black/95 flex items-center justify-center p-4 backdrop-blur-md overflow-y-auto">
            <div class="bg-[#0a0a0a] border border-[#333] w-full max-w-5xl rounded-2xl p-8 relative shadow-2xl my-auto">
                <button onclick="toggleAdminPanel()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï Close</button>
                
                <!-- Live Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4 pb-4 border-b border-gray-800">
                    <div class="flex items-center gap-3">
                        <h2 class="text-3xl font-bold text-white tracking-tight">System Monitor</h2>
                        <span class="px-3 py-1 bg-[#00ff88]/10 text-[#00ff88] border border-[#00ff88]/30 rounded-full text-[10px] font-bold flex items-center gap-2">
                            <span class="w-2 h-2 bg-[#00ff88] rounded-full live-dot"></span>
                            LIVE FEED
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-500 font-mono uppercase tracking-widest">Refresh Rate</p>
                        <p class="text-xs text-[#00ff88] font-bold font-mono flex items-center justify-end gap-2">
                            <span id="refresh-spinner" class="w-3 h-3 border-2 border-[#00ff88] border-t-transparent rounded-full animate-spin"></span>
                            1000ms (Realtime)
                        </p>
                    </div>
                </div>

                <!-- Announcement Manager -->
                <div class="mb-8 bg-[#111] border border-[#333] p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4 flex items-center gap-2 text-sm uppercase tracking-widest border-b border-gray-800 pb-2">
                        <span>üì¢</span> Live Announcement Center
                    </h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="admin-announcement-input" class="studio-input w-full rounded-lg p-3 text-sm font-mono" placeholder="Write a message for all users (e.g. Server Maintenance in 10 mins)...">
                        <div class="flex gap-2">
                            <button onclick="window.postAnnouncement()" class="bg-[#00ff88] text-black font-bold px-6 rounded-lg hover:bg-white transition uppercase text-xs tracking-widest whitespace-nowrap shadow-[0_0_15px_rgba(0,255,136,0.3)]">
                                Post Live
                            </button>
                            <button onclick="window.deleteAnnouncement()" class="bg-red-500/10 text-red-500 border border-red-500/50 font-bold px-6 rounded-lg hover:bg-red-500 hover:text-white transition uppercase text-xs tracking-widest whitespace-nowrap">
                                Delete
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2 ml-1">Current Active Message: <span id="admin-current-msg" class="text-[#00ff88] font-mono">None</span></p>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Stat Card 1 -->
                    <div class="admin-card group" id="card-generated">
                        <div class="flex justify-between items-start">
                            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold">Total Generated</p>
                            <svg class="w-4 h-4 text-[#00ff88] opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <h3 class="text-5xl font-black text-white mt-4 tracking-tighter" id="stat-generated">0</h3>
                        <p class="text-[10px] text-[#00ff88] mt-2 font-mono">‚ñ≤ Lifetime 2K Output</p>
                    </div>
                    
                    <!-- Stat Card 2 -->
                    <div class="admin-card border-[#ff9900]/20 group" id="card-pending">
                        <div class="flex justify-between items-start">
                            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold text-[#ff9900]">Live Pending</p>
                            <svg class="w-4 h-4 text-[#ff9900] opacity-50 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </div>
                        <h3 class="text-5xl font-black text-white mt-4 tracking-tighter" id="stat-pending">0</h3>
                        <p class="text-[10px] text-[#ff9900] mt-2 font-mono">‚óè Currently Processing</p>
                    </div>

                    <!-- Stat Card 3 -->
                    <div class="admin-card group" id="card-users">
                        <div class="flex justify-between items-start">
                            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold">Total Members</p>
                            <svg class="w-4 h-4 text-blue-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </div>
                        <h3 class="text-5xl font-black text-white mt-4 tracking-tighter" id="stat-users">0</h3>
                        <p class="text-[10px] text-blue-400 mt-2 font-mono">‚óè Active Accounts</p>
                    </div>

                    <!-- Stat Card 4 -->
                    <div class="admin-card border-red-900/20 group" id="card-failed">
                        <div class="flex justify-between items-start">
                            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold text-red-500">Failed Jobs</p>
                            <svg class="w-4 h-4 text-red-500 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="text-5xl font-black text-white mt-4 tracking-tighter" id="stat-failed">0</h3>
                        <p class="text-[10px] text-red-500 mt-2 font-mono">‚ñº System Errors</p>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-800 flex justify-between items-center">
                    <p class="text-xs text-gray-600 font-mono flex items-center gap-2">
                        System Status: <span class="text-[#00ff88]">OPERATIONAL</span>
                    </p>
                    <p class="text-[10px] text-gray-700 font-mono" id="last-update-time">Last Sync: Just now</p>
                </div>
            </div>
        </div>

        <div class="max-w-[1920px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- Controls -->
                <div class="space-y-6">
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <label class="text-xs font-bold text-gray-500 uppercase">Batch Prompts</label>
                            <span id="lineCount" class="text-[#00ff88] text-xs font-mono font-bold">0 Ready</span>
                        </div>
                        <textarea id="promptInput" rows="10" 
                            class="studio-input w-full rounded-none border-l-2 border-l-[#00ff88] p-4 text-sm font-mono leading-relaxed resize-none focus:bg-[#080808]"
                            placeholder="Enter prompts for batch generation...&#10;System locked to 2K Quality Pipeline."></textarea>
                    </div>

                    <div class="bg-[#0a0a0a] p-5 border border-gray-800 space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-bold text-gray-200 block">Balanced Engine</span>
                                <span class="text-[10px] text-gray-500">Auto-Enhance Active</span>
                            </div>
                            <div class="flex gap-1">
                                <div class="h-2 w-2 rounded-full bg-[#00ff88] animate-pulse"></div>
                                <div class="h-2 w-2 rounded-full bg-[#ff9900] animate-pulse delay-75"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500 font-mono">
                            <div class="flex items-center gap-2"><span class="text-[#00ff88]">‚óè</span> 1. Generate</div>
                            <div class="flex items-center gap-2"><span class="text-[#ff9900]">‚óè</span> 2. Auto-Enhance</div>
                            <div class="flex items-center gap-2"><span class="text-[#00ff88]">‚óè</span> Locked Seed</div>
                            <div class="flex items-center gap-2"><span class="text-[#00ff88]">‚óè</span> 2K Final</div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Dimensions</label>
                        <select id="ratioSelect" class="studio-input w-full rounded-none p-3 text-sm font-mono">
                            <option value="landscape">Landscape (2560x1440)</option>
                            <option value="portrait">Portrait (1440x2560)</option>
                            <option value="square">Square (2048x2048)</option>
                        </select>
                    </div>

                    <button onclick="startAutoPipeline()" id="genBtn"
                        class="studio-btn w-full py-5 font-black text-sm tracking-widest flex items-center justify-center gap-3">
                        <span>START PIPELINE</span>
                        <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                    </button>

                    <!-- Status Panel -->
                    <div id="progressArea" class="hidden space-y-2">
                        <div class="flex justify-between text-[10px] text-gray-500 font-mono">
                            <span id="statusText">IDLE</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="w-full bg-[#111] h-1">
                            <div id="progressBar" class="progress-fill bg-[#00ff88] h-full w-0 shadow-[0_0_15px_#00ff88]"></div>
                        </div>
                        <div class="text-[9px] text-gray-600 font-mono text-center pt-1" id="logText">
                            System Ready
                        </div>
                    </div>

                    <button onclick="downloadAll()" id="downloadBtn" 
                        class="w-full py-4 bg-[#111] hover:bg-[#1a1a1a] text-gray-400 hover:text-white text-xs font-bold uppercase tracking-widest transition hidden border border-gray-800">
                        Download ZIP (2K)
                    </button>
                </div>
            </div>

            <!-- Gallery -->
            <div class="lg:col-span-9 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-900">
                    <h2 class="text-xl font-light text-gray-400">YOUR <span class="text-white font-bold">GALLERY</span></h2>
                    <button onclick="clearGallery()" class="text-[10px] text-gray-600 hover:text-[#00ff88] transition font-mono uppercase tracking-widest">Clear Workspace</button>
                </div>
                
                <div id="imageGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                    <div id="emptyState" class="col-span-full h-96 flex flex-col items-center justify-center border border-dashed border-gray-900 text-gray-800">
                        <p class="font-mono text-xs tracking-widest">READY FOR PIPELINE...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, increment, onSnapshot, getDoc, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyDad3GhgWdCKU3dU1_4BOrLZUqJWdBDWR4",
            authDomain: "image-51860.firebaseapp.com",
            databaseURL: "https://image-51860-default-rtdb.firebaseio.com",
            projectId: "image-51860",
            storageBucket: "image-51860.firebasestorage.app",
            messagingSenderId: "153231836218",
            appId: "1:153231836218:web:21d720207627e5f5e06103",
            measurementId: "G-524HRCQZ8Z"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'progen-studio';
        const ADMIN_EMAIL = 'haideroffical16@gmail.com';

        // UI References
        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const userDisplay = document.getElementById('user-email-display');
        const authError = document.getElementById('auth-error');
        const adminBtn = document.getElementById('admin-stats-btn');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Logged In
                authContainer.classList.add('hidden-app');
                mainApp.classList.remove('hidden-app');
                setTimeout(() => mainApp.classList.remove('opacity-0'), 100);
                userDisplay.innerText = user.email || 'User';
                
                await initStats();
                initAnnouncementListener();

                if (user.email === ADMIN_EMAIL) {
                    adminBtn.classList.remove('hidden');
                    initAdminListener();
                } else {
                    adminBtn.classList.add('hidden');
                }
            } else {
                mainApp.classList.add('hidden-app', 'opacity-0');
                authContainer.classList.remove('hidden-app');
                adminBtn.classList.add('hidden');
            }
        });

        // Initialize Stats
        async function initStats() {
            try {
                const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_stats', 'summary');
                const docSnap = await getDoc(statsRef);
                if (!docSnap.exists()) {
                    await setDoc(statsRef, {
                        totalGenerated: 0,
                        totalFailed: 0,
                        totalUsers: 0,
                        pendingJobs: 0
                    });
                }
            } catch(e) { console.log("Stats check info:", e); }
        }

        // Announcement Logic (Global)
        function initAnnouncementListener() {
            const announcementRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_data', 'announcement');
            
            onSnapshot(announcementRef, (doc) => {
                const banner = document.getElementById('announcement-banner');
                const textSpan = document.getElementById('announcement-text');
                const adminMsg = document.getElementById('admin-current-msg');
                
                if (doc.exists() && doc.data().text) {
                    textSpan.innerText = doc.data().text;
                    banner.classList.remove('hidden');
                    if(adminMsg) adminMsg.innerText = doc.data().text;
                } else {
                    banner.classList.add('hidden');
                    if(adminMsg) adminMsg.innerText = "None";
                }
            });
        }

        // Admin Only Logic
        function initAdminListener() {
            const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_stats', 'summary');
            let lastData = {};

            setInterval(() => {
                document.getElementById('last-update-time').innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
                const spinner = document.getElementById('refresh-spinner');
                spinner.style.opacity = spinner.style.opacity === '0.5' ? '1' : '0.5';
            }, 1000);

            onSnapshot(statsRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    
                    updateStatWithEffect('stat-generated', data.totalGenerated || 0, 'card-generated');
                    updateStatWithEffect('stat-pending', data.pendingJobs || 0, 'card-pending');
                    updateStatWithEffect('stat-users', data.totalUsers || 0, 'card-users');
                    updateStatWithEffect('stat-failed', data.totalFailed || 0, 'card-failed');
                    
                    lastData = data;
                }
            });
        }

        function updateStatWithEffect(elementId, newValue, cardId) {
            const el = document.getElementById(elementId);
            if(el.innerText != newValue) {
                el.innerText = newValue;
                const card = document.getElementById(cardId);
                card.classList.remove('flash-update');
                void card.offsetWidth; 
                card.classList.add('flash-update');
            }
        }

        // Exposed Actions
        window.postAnnouncement = async () => {
            const input = document.getElementById('admin-announcement-input');
            if(!input.value) return;
            const announcementRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_data', 'announcement');
            try {
                await setDoc(announcementRef, { text: input.value, timestamp: Date.now() });
                input.value = '';
            } catch(e) { alert("Failed to post: " + e.message); }
        };

        window.deleteAnnouncement = async () => {
            const announcementRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_data', 'announcement');
            try {
                await deleteDoc(announcementRef);
            } catch(e) { alert("Failed to delete"); }
        };

        window.updateStats = async (type) => {
            if (!auth.currentUser) return;
            const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_stats', 'summary');
            try {
                if (type === 'start') await updateDoc(statsRef, { pendingJobs: increment(1) });
                else if (type === 'success') await updateDoc(statsRef, { pendingJobs: increment(-1), totalGenerated: increment(1) });
                else if (type === 'fail') await updateDoc(statsRef, { pendingJobs: increment(-1), totalFailed: increment(1) });
                else if (type === 'user_add') await updateDoc(statsRef, { totalUsers: increment(1) });
            } catch (e) {}
        };

        // Auth Forms
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            authError.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                let msg = "Login failed.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') msg = "Incorrect credentials.";
                authError.innerText = msg;
                authError.classList.remove('hidden');
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;
            authError.classList.add('hidden');

            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                window.updateStats('user_add');
            } catch (error) {
                let msg = error.message;
                if (error.code === 'auth/email-already-in-use') msg = "This email is already registered. Please Login instead.";
                else if (error.code === 'auth/weak-password') msg = "Password needs 6+ characters.";
                authError.innerText = msg;
                authError.classList.remove('hidden');
            }
        });

        window.handleLogout = () => signOut(auth);
        
        window.toggleAuthMode = () => {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            authError.classList.add('hidden');
        };
        
        window.toggleAdminPanel = () => {
            const panel = document.getElementById('admin-dashboard');
            panel.classList.toggle('hidden');
        };
    </script>

    <!-- APP LOGIC (Global Scope) -->
    <script>
        let generatedItems = [];
        let isProcessing = false;

        const BASE_TAGS = "(masterpiece), (best quality), (detailed)";
        const ENHANCE_TAGS = "(masterpiece), (best quality), (2k resolution), (QHD), (sharp focus:1.4), (highly detailed:1.3), (clean lines), (smooth texture), (noise free:1.5), (grain free:1.5), (clear photography), high fidelity, 8k uhd, dslr";
        const NEGATIVE_PROMPT = "blur, blurry, haze, noise, grain, grit, dots, distortion, low quality, jpeg artifacts, compression artifacts, dirty, messy, out of focus";

        document.getElementById('promptInput').addEventListener('input', function(e) {
            const lines = e.target.value.split('\n').filter(line => line.trim() !== '').length;
            document.getElementById('lineCount').innerText = `${lines} Ready`;
        });

        async function startAutoPipeline() {
            if (isProcessing) return;
            const input = document.getElementById('promptInput').value;
            const prompts = input.split('\n').filter(line => line.trim() !== '');
            if (prompts.length === 0) return alert("Please input prompts");

            isProcessing = true;
            toggleUI(true);
            
            // Auto Clear
            generatedItems = [];
            document.getElementById('imageGrid').innerHTML = '';

            const ratio = document.getElementById('ratioSelect').value;
            let width, height;
            
            switch(ratio) {
                case 'landscape': width = 2560; height = 1440; break;
                case 'portrait': width = 1440; height = 2560; break;
                case 'square': width = 2048; height = 2048; break;
            }

            // Initialize Slots
            for (let i = 0; i < prompts.length; i++) {
                const lockedSeed = Math.floor(Math.random() * 1000000000);
                generatedItems.push({ 
                    id: `img-${Date.now()}-${i}`,
                    prompt: prompts[i].trim(),
                    status: 'pending',
                    blob: null,
                    finalUrl: null,
                    width: width,
                    height: height,
                    seed: lockedSeed
                });
                createSlot(generatedItems[i].id, generatedItems[i].prompt, i + 1);
            }

            // BALANCED PIPELINE LOOP
            for (let i = 0; i < prompts.length; i++) {
                const item = generatedItems[i];
                
                updateProgress(i, prompts.length, "GENERATING BASE...");
                updateSlotStatus(item.id, "GENERATING...", "text-[#00ff88]");
                updateLog(`Pipeline Active: Item ${i+1}`);
                
                // Stats: Job Started
                if(window.updateStats) window.updateStats('start');

                try {
                    // Stagger slightly (1.5s) - Balanced speed
                    if(i > 0) await new Promise(r => setTimeout(r, 1500));
                    
                    const baseBlob = await generateBaseImage(item.prompt, item.width, item.height, item.seed);
                    const baseUrl = URL.createObjectURL(baseBlob);
                    
                    renderImage(item.id, baseUrl, item.prompt, i, false);
                    
                    // Fire Auto-Enhance
                    triggerAutoEnhance(item, i);

                } catch (e) {
                    console.error(e);
                    updateSlotStatus(item.id, "RETRYING...", "text-yellow-400");
                    try {
                        await new Promise(r => setTimeout(r, 2000));
                        const baseBlob = await generateBaseImage(item.prompt, item.width, item.height, item.seed);
                        const baseUrl = URL.createObjectURL(baseBlob);
                        renderImage(item.id, baseUrl, item.prompt, i, false);
                        triggerAutoEnhance(item, i);
                    } catch(err) {
                        updateSlotStatus(item.id, "FAILED", "text-red-500");
                        if(window.updateStats) window.updateStats('fail');
                    }
                }
            }
            
            updateLog("All Generations Queued. Enhancing...");
        }

        async function generateBaseImage(prompt, w, h, seed) {
            const finalPrompt = `${prompt}, ${BASE_TAGS} | negative_prompt: ${NEGATIVE_PROMPT}`;
            const encodedPrompt = encodeURIComponent(finalPrompt);
            const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${w}&height=${h}&nologo=true&model=flux&enhance=false&seed=${seed}&t=${Date.now()}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error("Gen Failed");
            return await response.blob();
        }

        async function triggerAutoEnhance(item, index) {
            const slot = document.getElementById(item.id);
            if(slot) {
                slot.classList.add('enhancing');
                updateSlotStatus(item.id, "AUTO-ENHANCING TO 2K...", "text-[#ff9900]");
                const spinner = slot.querySelector('.loading-overlay');
                if(spinner) spinner.classList.remove('hidden');
            }

            try {
                await new Promise(r => setTimeout(r, 1000));

                const finalPrompt = `${item.prompt}, ${ENHANCE_TAGS} | negative_prompt: ${NEGATIVE_PROMPT}`;
                const encodedPrompt = encodeURIComponent(finalPrompt);
                
                const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${item.width}&height=${item.height}&nologo=true&model=flux&enhance=true&seed=${item.seed}&t=${Date.now()}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error("Enhance Failed");
                const blob = await response.blob();
                
                if(blob.size < 5000) throw new Error("File too small");

                const objectUrl = URL.createObjectURL(blob);
                
                item.blob = blob;
                item.finalUrl = objectUrl;
                item.status = 'done';

                renderImage(item.id, objectUrl, item.prompt, index, true);
                
                // Stats: Success
                if(window.updateStats) window.updateStats('success');
                
                checkAllDone();

            } catch (e) {
                console.error("Enhance error", e);
                setTimeout(() => triggerAutoEnhance(item, index), 3000);
            }
        }

        function checkAllDone() {
            const allDone = generatedItems.every(i => i.status === 'done' || i.status === 'failed'); 
            if(allDone && generatedItems.length > 0) {
                 isProcessing = false;
                 toggleUI(false);
                 document.getElementById('statusText').innerText = "ALL COMPLETED";
                 document.getElementById('statusText').className = "text-[#00ff88]";
                 updateLog("Batch Complete");
            }
        }

        function createSlot(id, prompt, idx) {
            const grid = document.getElementById('imageGrid');
            const div = document.createElement('div');
            div.id = id;
            div.className = "image-card relative aspect-video bg-[#050505] flex flex-col justify-between overflow-hidden rounded-lg";
            div.innerHTML = `
                <div class="loading-overlay absolute inset-0 flex items-center justify-center z-20">
                    <div class="w-8 h-8 border-2 border-[#1a1a1a] border-t-[#00ff88] rounded-full animate-spin"></div>
                </div>
                <div class="img-container absolute inset-0 w-full h-full"></div>
                <div class="z-30 p-3 bg-black/60 backdrop-blur-sm border-b border-white/5 flex justify-between items-center absolute top-0 w-full">
                    <span class="status-text text-[10px] text-[#00ff88] font-bold font-mono">QUEUED...</span>
                    <span class="text-[10px] text-gray-500">#{idx}</span>
                </div>
            `;
            grid.prepend(div);
        }

        function renderImage(id, url, prompt, idx, isEnhanced) {
            const slot = document.getElementById(id);
            if (!slot) return;
            
            const container = slot.querySelector('.img-container');
            container.innerHTML = `<img src="${url}" class="w-full h-full object-cover animate-[fadeIn_0.5s_ease-out]" loading="lazy">`;

            const spinner = slot.querySelector('.loading-overlay');
            if(spinner) spinner.classList.add('hidden');

            if(isEnhanced) {
                slot.classList.remove('enhancing');
                slot.classList.add('done');
                updateSlotStatus(id, "2K FINISHED", "text-[#00ff88]");
                
                if(!slot.querySelector('.badge')) {
                    const badge = document.createElement('div');
                    badge.className = "badge absolute bottom-2 right-2 bg-black/70 px-2 py-1 border border-[#00ff88]/30 rounded z-30";
                    badge.innerHTML = `<span class="text-[9px] text-[#00ff88] font-bold tracking-widest">QHD</span>`;
                    slot.appendChild(badge);
                }

                if(!slot.querySelector('.actions')) {
                    const actions = document.createElement('div');
                    actions.className = "actions absolute inset-0 bg-black/80 opacity-0 hover:opacity-100 transition-opacity duration-200 flex flex-col justify-center items-center gap-3 backdrop-blur-[2px] z-40";
                    actions.innerHTML = `
                        <p class="text-[10px] text-gray-300 font-mono px-4 text-center line-clamp-2">${prompt}</p>
                        <div class="flex gap-3">
                            <button onclick="window.open('${url}', '_blank')" class="bg-[#00ff88] text-black text-[10px] px-4 py-2 font-bold uppercase tracking-wider hover:bg-white transition rounded-full">Zoom</button>
                            <a href="${url}" download="ProGen_2K_${idx}.png" class="border border-white text-white text-[10px] px-4 py-2 font-bold uppercase tracking-wider hover:bg-white hover:text-black transition rounded-full">Save</a>
                        </div>
                    `;
                    slot.appendChild(actions);
                } else {
                    const zoomBtn = slot.querySelector('button');
                    const saveBtn = slot.querySelector('a');
                    zoomBtn.onclick = () => window.open(url, '_blank');
                    saveBtn.href = url;
                }
            }
        }

        function updateSlotStatus(id, text, colorClass) {
            const slot = document.getElementById(id);
            if(slot) {
                const statusText = slot.querySelector('.status-text');
                if(statusText) {
                    statusText.innerText = text;
                    statusText.className = `status-text text-[10px] font-bold font-mono ${colorClass}`;
                }
            }
        }

        function toggleUI(processing) {
            const btn = document.getElementById('genBtn');
            const spinner = document.getElementById('btnSpinner');
            const progress = document.getElementById('progressArea');
            const download = document.getElementById('downloadBtn');
            
            btn.disabled = processing;
            processing ? spinner.classList.remove('hidden') : spinner.classList.add('hidden');
            processing ? progress.classList.remove('hidden') : null;
            !processing ? download.classList.remove('hidden') : download.classList.add('hidden');
            
            if(processing) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.querySelector('span').innerText = "PIPELINE RUNNING...";
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.querySelector('span').innerText = "START PIPELINE";
            }
        }

        function updateProgress(curr, total, text) {
            const pct = ((curr + 1)/total)*100;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${Math.round(pct)}%`;
            if(text) document.getElementById('statusText').innerText = `${text} ${curr+1}/${total}`;
        }
        
        function updateLog(text) {
            document.getElementById('logText').innerText = text;
        }

        function clearGallery() {
            if(isProcessing) return;
            document.getElementById('imageGrid').innerHTML = `
                <div id="emptyState" class="col-span-full h-96 flex flex-col items-center justify-center border border-dashed border-gray-900 text-gray-800">
                    <p class="font-mono text-xs tracking-widest">READY FOR PIPELINE...</p>
                </div>
            `;
            generatedItems = [];
            toggleUI(false);
            document.getElementById('progressArea').classList.add('hidden');
        }

        async function downloadAll() {
            if (generatedItems.length === 0) return;
            const btn = document.getElementById('downloadBtn');
            const oldText = btn.innerText;
            btn.innerText = "ZIPPING...";
            btn.disabled = true;

            const zip = new JSZip();
            const folder = zip.folder("ProGen_2K_Enhanced");
            
            generatedItems.forEach((i, idx) => {
                if(i.blob) folder.file(`ProGen_2K_${idx+1}.png`, i.blob);
            });
            
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "ProGen_2K_Auto.zip");
            
            btn.innerText = oldText;
            btn.disabled = false;
        }
    </script>
</body>
</html>
