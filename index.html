<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Creator Studio - Hybrid Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        @keyframes pulse-emerald { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .admin-pulse { animation: pulse-emerald 2s infinite; }
        .animate-fade-up { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#0B1120] text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- GLOBAL ANNOUNCEMENT -->
    <div id="global-announcement" class="hidden bg-gradient-to-r from-red-600 to-orange-600 text-white px-4 py-2 text-sm font-bold text-center shadow-lg z-[100] relative animate-fade-up flex justify-center items-center gap-2">
        <i data-lucide="megaphone" class="w-4 h-4"></i> <span id="announcement-text"></span>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-1 w-full h-full relative">
        
        <!-- LANDING -->
        <div id="landing-view" class="absolute inset-0 flex flex-col items-center justify-center p-6 z-10 transition-opacity duration-500">
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-900/20 rounded-full blur-3xl pointer-events-none"></div>
            <div class="bg-[#1E293B] border border-slate-700/50 px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest text-indigo-300 uppercase mb-6 shadow-lg">Powered by Grow with Haider</div>
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white mb-10 text-center">AI Creator Studio<br/><span class="text-emerald-400 text-2xl font-medium">Hybrid Edition</span></h1>
            
            <button onclick="checkAuthAndStart()" class="group relative bg-[#162032] border border-slate-800 rounded-3xl p-10 hover:border-emerald-500/50 transition-all duration-300 hover:shadow-2xl cursor-pointer transform hover:-translate-y-1 max-w-md w-full flex flex-col items-center">
                <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg mb-6"><i data-lucide="mic" class="w-10 h-10 text-white"></i></div>
                <h3 class="text-2xl font-bold text-white mb-2">Start Generating</h3>
                <p class="text-slate-400 text-sm mb-6">30+ Premium Voices • Unlimited Preview</p>
                <span class="flex items-center gap-2 px-6 py-2 bg-emerald-500/10 text-emerald-400 rounded-full text-sm font-bold group-hover:bg-emerald-500 group-hover:text-white transition-all">Open Studio <i data-lucide="arrow-right" class="w-4 h-4"></i></span>
            </button>
        </div>

        <!-- TOOL INTERFACE -->
        <div id="tool-view" class="absolute inset-0 flex flex-col bg-[#0B1120] hidden opacity-0 transition-opacity duration-500">
            <div class="border-b border-slate-800 bg-[#0F172A]/80 backdrop-blur-md sticky top-0 z-20 px-4 py-3 flex justify-between items-center">
                <button onclick="switchView('landing')" class="text-slate-400 hover:text-white flex gap-2 items-center"><i data-lucide="chevron-left" class="w-5 h-5"></i> Back</button>
                <h1 class="text-lg font-bold text-white flex items-center gap-2"><span class="bg-emerald-500/10 text-emerald-400 p-1 rounded"><i data-lucide="zap" class="w-4 h-4"></i></span> Hybrid TTS</h1>
                <div class="flex items-center gap-3">
                    <button id="admin-shortcut-btn" class="hidden px-3 py-1.5 bg-red-500/10 text-red-400 border border-red-500/20 rounded text-xs font-bold hover:bg-red-500/20 flex items-center gap-2" onclick="switchView('admin-dashboard')"><i data-lucide="shield" class="w-3 h-3"></i> Admin</button>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-slate-800 text-slate-400 relative" onclick="toggleSettings(true)"><i data-lucide="settings" class="w-5 h-5"></i><span id="key-indicator" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span></button>
                </div>
            </div>

            <div class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full grid lg:grid-cols-2 gap-6 overflow-y-auto">
                <div class="flex flex-col gap-4 h-full">
                    <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-1 flex-1 flex flex-col shadow-xl min-h-[300px]">
                        <textarea id="text-input" class="flex-1 w-full bg-transparent text-lg p-6 resize-none outline-none text-slate-200 placeholder:text-slate-600" placeholder="Type here... (Unlimited for Preview)"></textarea>
                        <div class="px-6 py-3 border-t border-slate-700/50 flex justify-between text-xs text-slate-500 font-mono">
                            <span id="system-key-badge" class="hidden text-emerald-400">⚡ Shared API Active</span>
                            <span><span id="char-count">0</span> chars</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="bg-[#1E293B] border border-slate-700 rounded-3xl overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B]"><span class="text-xs font-bold text-slate-400 uppercase">Configuration</span></div>
                        <div class="p-6 space-y-6">
                            <div>
                                <div class="flex justify-between mb-2 text-xs font-medium"><span class="text-slate-400 uppercase">Speed</span><span id="speed-val" class="text-emerald-400">1.0x</span></div>
                                <input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full accent-emerald-500">
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <button id="generate-btn" onclick="startApiGeneration()" class="py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold flex justify-center items-center gap-2 transition-all"><i data-lucide="download" class="w-4 h-4"></i> Download (HQ)</button>
                            </div>
                        </div>
                        <div class="px-6 py-2 bg-[#1E293B] text-xs font-bold text-slate-400 uppercase flex justify-between">
                            <span>Select Voice & Preview</span>
                            <span class="text-[10px] text-slate-500">30+ Models</span>
                        </div>
                        <div id="voice-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar h-64"></div>
                    </div>
                    
                    <!-- DOWNLOAD CARD -->
                    <div id="download-card" class="hidden bg-[#1E293B] border border-slate-700 rounded-3xl p-6 shadow-xl animate-fade-up">
                         <div class="flex justify-between items-center mb-4">
                             <span class="text-sm font-bold text-emerald-400">Generation Complete!</span>
                             <button onclick="document.getElementById('download-card').classList.add('hidden')" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                         </div>
                         <a id="download-link" href="#" download class="flex items-center justify-center gap-2 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors">
                             <i data-lucide="download" class="w-4 h-4"></i> Save .WAV File
                         </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard-view" class="absolute inset-0 bg-[#0B1120] flex flex-col hidden opacity-0 transition-opacity z-50">
            <div class="border-b border-red-900/30 bg-[#1E293B] px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <span class="bg-red-500/10 text-red-500 p-2 rounded-lg"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></span>
                    <div><h1 class="font-bold text-white">Admin Console</h1><p class="text-[10px] text-emerald-400 uppercase tracking-wider flex items-center gap-1"><span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> Live</p></div>
                </div>
                <div class="flex gap-3"><button onclick="loadAdminData()" class="px-4 py-2 bg-blue-900/20 text-blue-400 rounded-lg text-xs font-bold flex items-center gap-2 border border-blue-900/30"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh</button><button onclick="switchView('tool')" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold border border-slate-700">Exit</button></div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto">
                <div class="grid md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-[#162032] border border-slate-700 p-5 rounded-2xl">
                         <p class="text-slate-400 text-[10px] uppercase font-bold">Total Users</p><h3 id="stat-total-users" class="text-3xl font-bold text-white">0</h3>
                    </div>
                    <div class="bg-[#162032] border border-slate-700 p-5 rounded-2xl relative">
                        <div class="flex justify-between items-start mb-2"><p class="text-slate-400 text-[10px] uppercase font-bold">Processing Now</p><button onclick="resetPending()" class="text-slate-600 hover:text-white" title="Force Reset"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button></div>
                        <h3 id="stat-pending" class="text-3xl font-bold text-yellow-400">0</h3>
                    </div>
                    <div class="bg-[#162032] border border-slate-700 p-5 rounded-2xl">
                         <p class="text-slate-400 text-[10px] uppercase font-bold">Total Gens</p><h3 id="stat-total-gens" class="text-3xl font-bold text-white">0</h3>
                    </div>
                     <div class="bg-[#162032] border border-slate-700 p-5 rounded-2xl">
                         <p class="text-slate-400 text-[10px] uppercase font-bold">Failed</p><h3 id="stat-failed" class="text-3xl font-bold text-red-400">0</h3>
                    </div>
                </div>
                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-[#1E293B] border border-slate-700 rounded-2xl overflow-hidden shadow-xl flex flex-col h-[400px]">
                        <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B]"><h2 class="text-sm font-bold text-white">Activity Logs (Full Text)</h2></div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar"><table class="w-full text-left text-sm text-slate-400"><tbody id="activity-log-list"></tbody></table></div>
                    </div>
                    <div class="space-y-6">
                         <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-sm font-bold text-white mb-4">Announcement</h3>
                            <textarea id="announce-input" class="w-full bg-[#0B1120] border border-slate-700 rounded p-2 text-xs text-white mb-2 h-20" placeholder="Message..."></textarea>
                            <button onclick="postAnnouncement()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-1.5 rounded text-xs font-bold">Post Live</button>
                        </div>
                         <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6">
                            <h3 class="text-sm font-bold text-white mb-4 flex justify-between"><span>System Keys</span> <span id="stat-keys-count" class="text-[10px] bg-slate-800 px-2 rounded pt-0.5">0</span></h3>
                            <input id="sys-key-input" class="w-full bg-[#0B1120] border border-slate-700 rounded p-2 text-xs text-white mb-2" placeholder="Paste API Key">
                            <button onclick="addSysKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-1.5 rounded text-xs font-bold">Add Key</button>
                            <div class="mt-3 pt-3 border-t border-slate-700 max-h-24 overflow-y-auto custom-scrollbar"><ul id="system-keys-mini-list" class="text-[10px] font-mono text-slate-500 space-y-1"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS & AUTH MODALS -->
        <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-start justify-center pt-20 hidden">
            <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6 w-full max-w-md relative">
                <button onclick="toggleSettings(false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                <h3 class="text-white font-bold mb-4">API Settings</h3>
                <input id="api-key-input" type="password" placeholder="Personal API Key..." class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-sm text-white mb-4">
                <button onclick="saveLocalKey()" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold">Save Key</button>
                <p class="text-[10px] text-slate-500 mt-2 text-center">If admin added keys, you don't need this.</p>
            </div>
        </div>
        
        <div id="auth-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center hidden">
            <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-8 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold text-white mb-6">Login Required</h2>
                <input id="login-email" placeholder="Email" class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-white mb-3">
                <input id="login-pass" type="password" placeholder="Password" class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-white mb-6">
                <button onclick="doLogin()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl">Enter Studio</button>
            </div>
        </div>
        
        <div id="toast-box" class="fixed bottom-6 right-6 bg-[#1E293B] border-l-4 border-emerald-500 text-white p-4 rounded shadow-2xl hidden z-[70]"></div>
    </div>

    <script>
        const firebaseConfig = {apiKey: "AIzaSyBAbtakEQ9vl9Khz91D8HD8uDeQR8nUHa4",authDomain: "creator-studio-new.firebaseapp.com",projectId: "creator-studio-new",storageBucket: "creator-studio-new.firebasestorage.app",messagingSenderId: "512739989726",appId: "1:512739989726:web:84b798168ca876ff628a4f"};
        const ADMIN_EMAIL = "haideroffical16@gmail.com";
        const appId = "creator-studio-new";
        let app, auth, db, systemKeys=[];
        let nativeVoices = [];
        
        try { app=firebase.initializeApp(firebaseConfig); auth=firebase.auth(); db=firebase.firestore(); db.enablePersistence().catch(()=>{}); } catch(e){}

        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const VOICES = [
            {id:"Fenrir",gender:"Male"}, {id:"Kore",gender:"Female"}, {id:"Puck",gender:"Male"}, {id:"Aoede",gender:"Female"},
            {id:"Charon",gender:"Male"}, {id:"Zephyr",gender:"Male"}, {id:"Leda",gender:"Female"}, {id:"Orus",gender:"Male"},
            {id:"Umbriel",gender:"Male"}, {id:"Iapetus",gender:"Male"}, {id:"Callirrhoe",gender:"Female"}, {id:"Autonoe",gender:"Female"},
            {id:"Enceladus",gender:"Male"}, {id:"Algieba",gender:"Female"}, {id:"Despina",gender:"Female"}, {id:"Erinome",gender:"Female"},
            {id:"Algenib",gender:"Male"}, {id:"Rasalgethi",gender:"Male"}, {id:"Laomedeia",gender:"Female"}, {id:"Achernar",gender:"Male"},
            {id:"Alnilam",gender:"Male"}, {id:"Schedar",gender:"Male"}, {id:"Gacrux",gender:"Male"}, {id:"Pulcherrima",gender:"Female"},
            {id:"Achird",gender:"Female"}, {id:"Zubenelgenubi",gender:"Male"}, {id:"Vindemiatrix",gender:"Female"}, {id:"Sadachbia",gender:"Female"},
            {id:"Sadaltager",gender:"Male"}, {id:"Sulafat",gender:"Female"}
        ];
        
        let state = { text:"", selectedVoiceId:"Fenrir", localKeys:[], speed:1.0, currentUser:null, isAdmin:false };

        function init(){
            try{lucide.createIcons();}catch(e){}
            
            window.speechSynthesis.onvoiceschanged = () => { nativeVoices = window.speechSynthesis.getVoices(); };
            // Attempt load immediately
            nativeVoices = window.speechSynthesis.getVoices();
            
            renderVoices();
            const k=localStorage.getItem("local_api_keys"); if(k) state.localKeys=JSON.parse(k);
            updateKeyStatus();
            
            if(auth) {
                auth.onAuthStateChanged(u=>{
                    state.currentUser=u;
                    if(u){
                        state.isAdmin=(u.email.toLowerCase().trim()===ADMIN_EMAIL.toLowerCase());
                        if(document.getElementById('admin-shortcut-btn')) document.getElementById('admin-shortcut-btn').classList.toggle('hidden',!state.isAdmin);
                        if(document.getElementById('auth-modal')) document.getElementById('auth-modal').classList.add('hidden');
                        if(document.getElementById('login-btn')) document.getElementById('login-btn').classList.add('hidden');
                        
                        loadSystemKeys(); 
                        if(state.isAdmin) loadAdminData();
                        
                        getArtifactRef('system_config').doc('announcement').onSnapshot(d=>{
                            if(d.exists && d.data().active){
                                if(document.getElementById('global-announcement')) document.getElementById('global-announcement').classList.remove('hidden');
                                if(document.getElementById('announcement-text')) document.getElementById('announcement-text').innerText=d.data().message;
                            } else if(document.getElementById('global-announcement')) document.getElementById('global-announcement').classList.add('hidden');
                        }, (e)=>{});
                    } else {
                        if(document.getElementById('auth-modal')) document.getElementById('auth-modal').classList.remove('hidden');
                    }
                });
            }
            const txtIn = getEl('text-input'); if(txtIn) txtIn.oninput=(e)=>{state.text=e.target.value;getEl('char-count').innerText=state.text.length;};
            const spdIn = getEl('speed-range'); if(spdIn) spdIn.oninput=(e)=>{state.speed=parseFloat(e.target.value);getEl('speed-val').innerText=state.speed+'x';};
        }

        // --- HELPERS ---
        function getRootRef(col){ return db.collection(col); }
        function getArtifactRef(col){ return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(col); }

        // --- MAIN FUNCTIONS ---
        function renderVoices(){ 
            const l=document.getElementById('voice-list'); if(!l)return; l.innerHTML=""; 
            VOICES.forEach((v, i)=>{ 
                const el=document.createElement('div'); el.className=`flex justify-between items-center p-2 rounded hover:bg-slate-800 cursor-pointer mb-1 ${state.selectedVoiceId===v.id?'bg-emerald-500/20 text-emerald-400':'text-slate-400'}`;
                el.innerHTML=`
                    <div class="flex-1" onclick="selectVoice('${v.id}')"><span class="font-medium">${v.id}</span> <span class="text-[10px] opacity-50 ml-2">${v.gender}</span></div>
                    <button onclick="event.stopPropagation(); playPreviewForVoice('${v.id}', '${v.gender}', ${i})" class="p-1.5 rounded-full hover:bg-emerald-500/20 text-emerald-500" title="Instant Preview"><i data-lucide="play" class="w-3 h-3 fill-current"></i></button>
                `;
                l.appendChild(el);
            });
            try{ lucide.createIcons(); }catch(e){}
        }
        
        function selectVoice(id) { state.selectedVoiceId = id; renderVoices(); }

        // SMART VOICE MAPPER (Fixes "Same Voice" issue by checking gender keywords AND varying pitch)
        function playPreviewForVoice(id, gender, index) {
            const txt = state.text || "This is a preview of " + id;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            
            // PITCH SHIFT HACK: Force different pitch for M/F to simulate difference even if system has 1 voice
            if(gender.toLowerCase() === 'male') {
                u.pitch = 0.8; // Deepen
            } else {
                u.pitch = 1.2; // Lighten
            }
            u.rate = state.speed; // Respect speed slider

            // Try to pick best voice
            let avail = nativeVoices;
            const targetGender = gender.toLowerCase();
            let genderMatch = avail.filter(v => {
                const name = v.name.toLowerCase();
                if(targetGender === 'female') return name.includes('female') || name.includes('zira') || name.includes('samantha');
                if(targetGender === 'male') return name.includes('male') || name.includes('david') || name.includes('daniel');
                return false;
            });
            if(genderMatch.length === 0) genderMatch = avail.filter(v => v.lang.startsWith("en")); // Fallback to any English
            
            if(genderMatch.length > 0) {
                u.voice = genderMatch[index % genderMatch.length]; // Rotate voices
            }
            
            window.speechSynthesis.speak(u);
            showToast(`Previewing ${id} (${gender})...`, "info");
        }

        // --- API DOWNLOAD (Correct WAV Stitching) ---
        async function startApiGeneration(){
            if(!state.text){ showToast("Enter text first"); return; }
            const keys = state.localKeys.length?state.localKeys:systemKeys;
            if(!keys.length){ showToast("System Maintenance (No Keys).", "error"); return; }
            
            const btn = document.getElementById('generate-btn');
            // Initial Loading State
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Preparing...`; 
            btn.disabled = true;

            let logId = await logActivity(state.text, "processing");
            if(db) getArtifactRef('stats').doc('global').update({pending_generations: firebase.firestore.FieldValue.increment(1)}).catch(()=>{});

            try {
                const chunks = chunkText(state.text, 4000);
                let audioBuffers = [];
                
                for(let i=0; i<chunks.length; i++){
                    // UPDATE BUTTON TEXT WITH PROGRESS
                    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processing Part ${i+1}/${chunks.length}...`;
                    
                    const ab = await fetchTTS(chunks[i], state.selectedVoiceId, keys);
                    audioBuffers.push(ab);
                }
                
                // STITCHING: Merge WAVs correctly by removing headers
                const finalBlob = mergeWavBuffers(audioBuffers);
                const url = URL.createObjectURL(finalBlob);
                
                document.getElementById('download-link').href = url;
                document.getElementById('download-link').download = `tts-${Date.now()}.wav`;
                document.getElementById('download-card').classList.remove('hidden');
                
                updateLog(logId, "completed");
                if(db) getArtifactRef('stats').doc('global').update({pending_generations: firebase.firestore.FieldValue.increment(-1), total_generations: firebase.firestore.FieldValue.increment(1)});
                showToast("Download Ready!", "success");

            } catch(e){
                console.error(e);
                showToast("Failed: " + e.message, "error");
                updateLog(logId, "failed");
                if(db) getArtifactRef('stats').doc('global').update({pending_generations: firebase.firestore.FieldValue.increment(-1), failed_generations: firebase.firestore.FieldValue.increment(1)});
            }
            // Reset Button
            btn.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i> Download (HQ)`; 
            btn.disabled = false; 
            try{lucide.createIcons();}catch(e){}
        }

        // --- WAV MERGER (The Fix for Corrupt Files) ---
        function mergeWavBuffers(buffers) {
            if(buffers.length === 0) return new Blob([]);
            
            const HEADER_SIZE = 44;
            let totalDataLen = 0;
            
            const dataParts = buffers.map(b => {
                // If buffer is valid WAV, it has 'RIFF' at 0. Data starts at 44.
                if(b.byteLength < HEADER_SIZE) return b; 
                
                const view = new DataView(b);
                if(view.getUint32(0, false) === 0x52494646) { // 'RIFF'
                    totalDataLen += (b.byteLength - HEADER_SIZE);
                    return b.slice(HEADER_SIZE);
                } else {
                    totalDataLen += b.byteLength;
                    return b;
                }
            });
            
            const header = createWavHeader(totalDataLen);
            return new Blob([header, ...dataParts], {type: 'audio/wav'});
        }
        
        function createWavHeader(dataLength) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); 
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); 
            view.setUint32(24, 24000, true); view.setUint32(28, 24000 * 2, true); 
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true); 
            
            return buffer;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function fetchTTS(text, vid, keyPool){
            let attempts=0;
            while(attempts < keyPool.length*2){
                const key = keyPool[attempts % keyPool.length];
                if(!key) { attempts++; continue; }
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${key}`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({contents:[{parts:[{text}]}], generationConfig:{responseModalities:["AUDIO"], speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:vid}}}}})
                    });
                    if(!r.ok) {
                        if(r.status===429) { await new Promise(r=>setTimeout(r,1000)); attempts++; continue; }
                        if(r.status===403) { attempts++; continue; }
                        throw new Error(r.status);
                    }
                    const d = await r.json();
                    const bin = atob(d.candidates[0].content.parts[0].inlineData.data);
                    const len = bin.length; const bytes = new Uint8Array(len);
                    for (let i=0; i<len; i++) bytes[i] = bin.charCodeAt(i);
                    return bytes.buffer;
                } catch(e){ attempts++; }
            }
            throw new Error("Server Busy / Quota Exceeded");
        }

        // --- ADMIN & DATA (HYBRID) ---
        function loadAdminData(){
            if(!db) return;
            let rStats={}, aStats={};
            const upS = () => {
                const tU=(rStats.total_users||0)+(aStats.total_users||0);
                const tG=(rStats.total_generations||0)+(aStats.total_generations||0);
                const tF=(rStats.failed_generations||0)+(aStats.failed_generations||0);
                const tP=(rStats.pending_generations||0)+(aStats.pending_generations||0);
                if(getEl('stat-total-users')) getEl('stat-total-users').innerText=tU;
                if(getEl('stat-total-gens')) getEl('stat-total-gens').innerText=tG;
                if(getEl('stat-failed')) getEl('stat-failed').innerText=tF;
                if(getEl('stat-pending')) getEl('stat-pending').innerText=tP;
            }
            getRootRef('stats').doc('global').onSnapshot(d=>{if(d.exists)rStats=d.data();upS();});
            getArtifactRef('stats').doc('global').onSnapshot(d=>{if(d.exists)aStats=d.data();upS();});

            getArtifactRef('activity_logs').orderBy('timestamp','desc').limit(20).onSnapshot(s=>{
                const l=getEl('activity-log-list'); if(l){ l.innerHTML=""; s.forEach(d=>{
                    const da=d.data(); const t=da.timestamp?new Date(da.timestamp.seconds*1000).toLocaleTimeString():'';
                    const st=da.status==='completed'?'text-emerald-400':(da.status==='failed'?'text-red-400':'text-yellow-400');
                    const safeText = (da.fullText || "").replace(/</g, "&lt;");
                    l.innerHTML += `<tr class="border-b border-slate-700/50"><td class="p-3 w-1/4 align-top"><div class="font-bold text-white text-xs">${da.userEmail?.split('@')[0]}</div><div class="text-[10px] text-slate-500">${t}</div><div class="text-[10px] uppercase ${st}">${da.status}</div></td><td class="p-3 w-3/4"><div class="max-h-24 overflow-y-auto text-xs text-slate-300 bg-slate-800/50 p-2 rounded whitespace-pre-wrap custom-scrollbar">${safeText}</div></td></tr>`;
                });}
            });
        }

        // --- SHARED FUNCTIONS ---
        async function logActivity(txt, st){
            if(!db || !state.currentUser) return null;
            const ref = await getArtifactRef('activity_logs').add({fullText: txt, status: st, timestamp: firebase.firestore.FieldValue.serverTimestamp(), userEmail: state.currentUser.email, voice: state.selectedVoiceId});
            return ref.id;
        }
        function updateLog(id, st){ if(id && db) getArtifactRef('activity_logs').doc(id).update({status:st}); }
        function chunkText(s, len){ const r=[]; for(let i=0;i<s.length;i+=len)r.push(s.substring(i,i+len)); return r; }
        
        // Admin Actions
        function resetPending(){ if(db) getArtifactRef('stats').doc('global').update({pending_generations:0}); showToast("Reset Done"); }
        async function postAnnouncement(){ const t=getEl('announce-input').value; if(db) await getArtifactRef('system_config').doc('announcement').set({message:t,active:true}); showToast("Posted"); }
        async function deleteAnnouncement(){ if(db) await getArtifactRef('system_config').doc('announcement').update({active:false}); getEl('announce-input').value=""; showToast("Deleted"); }
        async function addSysKey(){ const k=getEl('sys-key-input').value.trim(); if(k && db) { await getArtifactRef('system_keys').add({key:k,addedAt:firebase.firestore.FieldValue.serverTimestamp()}); showToast("Key Added"); getEl('sys-key-input').value=""; } }
        async function loadSystemKeys(){ 
            if(!db) return; 
            const s1 = await getRootRef('system_keys').get(); const s2 = await getArtifactRef('system_keys').get();
            const k1 = s1.docs.map(d=>d.data().key); const k2 = s2.docs.map(d=>d.data().key);
            systemKeys = [...new Set([...k1, ...k2])];
            if(getEl('stat-keys-count')) getEl('stat-keys-count').innerText=systemKeys.length; 
            const l=getEl('system-keys-mini-list'); if(l){ l.innerHTML=""; systemKeys.forEach(k=>l.innerHTML+=`<li class="truncate text-slate-500 bg-slate-800 p-1 rounded mb-1">${k.substr(0,8)}...</li>`); }
            updateKeyStatus();
        }

        // Auth
        async function doLogin(){
            const e=getEl('login-email').value, p=getEl('login-pass').value;
            try{ await auth.signInWithEmailAndPassword(e,p); }
            catch(err){ try{ await auth.createUserWithEmailAndPassword(e,p); if(db) getArtifactRef('stats').doc('global').set({total_users:firebase.firestore.FieldValue.increment(1)},{merge:true}); } catch(er){ getEl('auth-msg').innerText=er.message; } }
        }
        function saveLocalKey(){ const k=getEl('api-key-input').value; if(k){ state.localKeys=[k]; localStorage.setItem("local_api_keys",JSON.stringify([k])); updateKeyStatus(); showToast("Saved"); toggleSettings(false); } }
        function clearLocalKeys(){ state.localKeys=[]; localStorage.removeItem("local_api_keys"); updateKeyStatus(); showToast("Cleared"); }
        function updateKeyStatus(){ 
            const hasSystem = systemKeys.length > 0;
            const hasLocal = state.localKeys.length > 0;
            const badge = getEl('system-key-badge');
            const ind = getEl('key-indicator');
            
            if(hasLocal) { if(ind) ind.className='absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full'; if(badge){badge.classList.remove('hidden'); badge.innerText='⚡ Personal Key Active'; badge.className='text-green-400';} }
            else if(hasSystem) { if(ind) ind.className='absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full animate-pulse'; if(badge){badge.classList.remove('hidden'); badge.innerText='⚡ Shared API Active'; badge.className='text-blue-400';} }
            else { if(ind) ind.className='absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full'; if(badge) badge.classList.add('hidden'); }
        }

        function checkAuthAndStart() { if (state.currentUser) switchView('tool'); else if(document.getElementById('auth-modal')) document.getElementById('auth-modal').classList.remove('hidden'); }
        function switchView(v){ ['landing-view','tool-view','admin-dashboard-view'].forEach(i=>{ const el=document.getElementById(i); if(el) el.classList.add('hidden','opacity-0'); }); const newV=document.getElementById(v+'-view'); if(newV) { newV.classList.remove('hidden'); setTimeout(()=>newV.classList.remove('opacity-0'),50); } }
        function showToast(m,t="info"){ const b=getEl('toast-box'); if(!b) return; b.innerText=m; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'), 4000); }
        function toggleSettings(s){ const el=getEl('settings-modal'); if(el) el.classList.toggle('hidden', !s); }
        function getEl(id){ return document.getElementById(id); }

        init();
    </script>
</body>
</html>
